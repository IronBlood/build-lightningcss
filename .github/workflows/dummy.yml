name: dummy
on:
  workflow_dispatch:

jobs:
  check-llvm-strip:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      - name: Install llvm
        run: sudo apt-get update && sudo apt-get install -y llvm
      - name: Check llvm-strip
        run: which llvm-strip
  show-android-linker:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      - name: Download NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r28-linux.zip -O ndk.zip
          unzip ndk.zip
      - name: Show binaries
        run: |
          ls android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64/bin
  inspect-armv7-test-binary:
    if: ${{ false }}
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Install build deps
        run: |
          sudo dpkg --add-architecture armhf
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf binutils file libc6:armhf libgcc-s1:armhf libstdc++6:armhf
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabihf
      - name: Set target
        working-directory: lightningcss
        run: rustup target add armv7-unknown-linux-gnueabihf
      - name: Build armv7 test binary
        working-directory: lightningcss
        run: cargo test --no-run --target armv7-unknown-linux-gnueabihf
      - name: Inspect armv7 test binary
        working-directory: lightningcss
        run: |
          bin_path=$(find target/armv7-unknown-linux-gnueabihf/debug/deps -maxdepth 1 -type f -executable -name 'lightningcss-*' | head -n 1)
          file "$bin_path"
          ldd "$bin_path" || true
          readelf -l "$bin_path" | sed -n '1,80p'
      - name: Run armv7 test binary
        working-directory: lightningcss
        run: |
          bin_path=$(find target/armv7-unknown-linux-gnueabihf/debug/deps -maxdepth 1 -type f -executable -name 'lightningcss-*' | head -n 1)
          "$bin_path"
  test-upstream-x64-musl:
    name: Test upstream x64 musl binding - node@${{ matrix.node }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node:
          - "20"
          - "22"
          - "24"
    steps:
      - name: Clone upstream
        run: git clone --depth 1 https://github.com/parcel-bundler/lightningcss lightningcss
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: yarn
          cache-dependency-path: lightningcss/yarn.lock
      - name: Install dependencies
        working-directory: lightningcss
        run: yarn install --ignore-scripts
      - name: Download musl package
        run: |
          mkdir -p /tmp/lightningcss-pkg
          cd /tmp/lightningcss-pkg
          npm pack lightningcss-linux-arm64-musl
          tar -xzf lightningcss-linux-arm64-musl-*.tgz
          ls -alh
          mv package/lightningcss.linux-x64-musl.node "${{ github.workspace }}/lightningcss/lightningcss.linux-x64-musl.node"
      - name: Test bindings
        uses: addnab/docker-run-action@v3
        with:
          image: node:${{ matrix.node }}-alpine
          options: -v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}/lightningcss
          run: yarn test
