name: dummy
on:
  workflow_dispatch:

jobs:
  check-llvm-strip:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      - name: Install llvm
        run: sudo apt-get update && sudo apt-get install -y llvm
      - name: Check llvm-strip
        run: which llvm-strip
  show-android-linker:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      - name: Download NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r28-linux.zip -O ndk.zip
          unzip ndk.zip
      - name: Show binaries
        run: |
          ls android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64/bin
  inspect-armv7-test-binary:
    if: ${{ false }}
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Install build deps
        run: |
          sudo dpkg --add-architecture armhf
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf binutils file libc6:armhf libgcc-s1:armhf libstdc++6:armhf
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabihf
      - name: Set target
        working-directory: lightningcss
        run: rustup target add armv7-unknown-linux-gnueabihf
      - name: Build armv7 test binary
        working-directory: lightningcss
        run: cargo test --no-run --target armv7-unknown-linux-gnueabihf
      - name: Inspect armv7 test binary
        working-directory: lightningcss
        run: |
          bin_path=$(find target/armv7-unknown-linux-gnueabihf/debug/deps -maxdepth 1 -type f -executable -name 'lightningcss-*' | head -n 1)
          file "$bin_path"
          ldd "$bin_path" || true
          readelf -l "$bin_path" | sed -n '1,80p'
      - name: Run armv7 test binary
        working-directory: lightningcss
        run: |
          bin_path=$(find target/armv7-unknown-linux-gnueabihf/debug/deps -maxdepth 1 -type f -executable -name 'lightningcss-*' | head -n 1)
          "$bin_path"
  test-upstream-x64-musl:
    if: ${{ false }}
    name: Test upstream x64 musl binding - node@${{ matrix.node }}
    runs-on: ubuntu-latest
    env:
      LIGHTNINGCSS_VERSION: "1.30.2"
    strategy:
      fail-fast: false
      matrix:
        node:
          - "20"
          - "22"
          - "24"
    steps:
      - name: Clone upstream
        run: git clone --depth 1 --branch v${{ env.LIGHTNINGCSS_VERSION }} https://github.com/parcel-bundler/lightningcss lightningcss
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: yarn
          cache-dependency-path: lightningcss/yarn.lock
      - name: Install dependencies
        working-directory: lightningcss
        run: yarn install --ignore-scripts
      - name: Download musl package
        run: |
          mkdir -p /tmp/lightningcss-pkg
          cd /tmp/lightningcss-pkg
          npm pack lightningcss-linux-x64-musl@${{ env.LIGHTNINGCSS_VERSION }}
          tar -xzf lightningcss-linux-x64-musl-*.tgz
          mv package/lightningcss.linux-x64-musl.node "${{ github.workspace }}/lightningcss/lightningcss.linux-x64-musl.node"
      - name: Test bindings
        uses: addnab/docker-run-action@v3
        with:
          image: node:${{ matrix.node }}-alpine
          options: -v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}/lightningcss
          run: yarn test
  test-upstream-win-bindings:
    if: ${{ false }}
    name: Test upstream Windows bindings on ${{ matrix.settings.host }} - node@${{ matrix.node }}
    runs-on: ${{ matrix.settings.host }}
    env:
      LIGHTNINGCSS_VERSION: "1.30.2"
    strategy:
      fail-fast: false
      matrix:
        node:
          - "20"
          - "22"
          - "24"
        settings:
          - host: windows-latest
            package: lightningcss-win32-x64-msvc
            binary: lightningcss.win32-x64-msvc.node
          - host: windows-11-arm
            package: lightningcss-win32-arm64-msvc
            binary: lightningcss.win32-arm64-msvc.node
    steps:
      - uses: actions/checkout@v6
      - name: Clone upstream
        run: git clone --depth 1 --branch v${{ env.LIGHTNINGCSS_VERSION }} https://github.com/parcel-bundler/lightningcss lightningcss
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: yarn
          cache-dependency-path: lightningcss/yarn.lock
      - name: Install dependencies
        working-directory: lightningcss
        run: yarn install --ignore-scripts
      - name: Download Windows package
        shell: bash
        run: |
          mkdir -p "$GITHUB_WORKSPACE/lightningcss-pkg"
          cd "$GITHUB_WORKSPACE/lightningcss-pkg"
          npm pack ${{ matrix.settings.package }}@${{ env.LIGHTNINGCSS_VERSION }}
          tar -xzf ${{ matrix.settings.package }}-*.tgz
          ls -alh .
          ls -alh package
          mv "package/${{ matrix.settings.binary }}" "$GITHUB_WORKSPACE/lightningcss/${{ matrix.settings.binary }}"
      - name: Patch tests
        working-directory: lightningcss
        run: git apply -v ../node_test_bundle_normalize.patch
      - name: Test bindings
        working-directory: lightningcss
        run: yarn test
  test-upstream-win-rust:
    name: Test upstream Rust on ${{ matrix.settings.target }} @ ${{ matrix.ref }}
    runs-on: ${{ matrix.settings.host }}
    strategy:
      fail-fast: false
      matrix:
        ref:
          - v1.30.2
          - master
        settings:
          - host: windows-latest
            target: x86_64-pc-windows-msvc
          - host: windows-latest
            target: i686-pc-windows-msvc
          - host: windows-11-arm
            target: aarch64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v6
      - name: Clone upstream
        run: git clone --depth 1 --branch ${{ matrix.ref }} https://github.com/parcel-bundler/lightningcss lightningcss
      - name: Apply Windows patch
        if: ${{ matrix.ref == 'v1.30.2' }}
        working-directory: lightningcss
        run: git apply -v ../windows.patch
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}
      - name: Cargo test (Build)
        working-directory: lightningcss
        run: |
          rustup target add ${{ matrix.settings.target }}
          cargo test --all-features --no-run --target ${{ matrix.settings.target }} --no-fail-fast
      - name: Run CLI manually
        shell: bash
        working-directory: lightningcss
        env:
          LIGHTNINGCSS_DEBUG_PATHS: 1
        run: |
          target/debug/lightningcss.exe ../test.css --css-modules 2>debug.info
          cat debug.info
      - name: Cargo test
        working-directory: lightningcss
        env:
          CARGO_TERM_COLOR: always
          RUST_BACKTRACE: full
          RUSTFLAGS: -D warnings
        run: |
          cargo test --all-features --target ${{ matrix.settings.target }} --no-fail-fast
