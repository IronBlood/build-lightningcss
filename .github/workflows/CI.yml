name: CI
env:
  DEBUG: napi:*
  APP_NAME: lightningcss
  MACOSX_DEPLOYMENT_TARGET: "10.13"
  WORKING_DIRECTORY: lightningcss
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"
on:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        settings:
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
          - os: windows-latest
            target: i686-pc-windows-msvc
          # MacOS
          - os: macos-latest
            target: x86_64-apple-darwin
            strip: strip -x
          - os: macos-latest
            target: aarch64-apple-darwin
            strip: strip -x
            jemalloc_lg_page: "14"
          # Linux
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            strip: strip
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            strip: strip
            cross: zig
          - os: ubuntu-latest
            strip: aarch64-linux-gnu-strip
            target: aarch64-unknown-linux-gnu
            cross: napi
            setup: |
              sudo apt update
              sudo apt install -y gcc-aarch64-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            strip: llvm-strip
            cross: zig
            setup: |
              sudo apt update
              sudo apt install -y llvm
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            strip: llvm-strip
            cross: napi
            setup: |
              sudo apt update
              sudo apt install -y gcc-arm-linux-gnueabihf llvm
          - os: ubuntu-latest
            android: true
            target: aarch64-linux-android
            strip: llvm-strip
            android_home: /tmp/android-ndk-r28
            linker: CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=/tmp/android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
            setup: sudo apt update && sudo apt install -y llvm
          - os: ubuntu-latest
            android: true
            target: armv7-linux-androideabi
            strip: llvm-strip
            android_home: /tmp/android-ndk-r28
            linker: CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=/tmp/android-ndk-r28/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
            setup: sudo apt update && sudo apt install -y llvm
          - os: ubuntu-latest
            target: powerpc64le-unknown-linux-gnu
            strip: powerpc64le-linux-gnu-strip
            linker: CARGO_TARGET_POWERPC64LE_UNKNOWN_LINUX_GNU_LINKER=powerpc64le-linux-gnu-gcc
            setup: |
              sudo apt update
              sudo apt install -y gcc-powerpc64le-linux-gnu libc6-dev-ppc64el-cross
          - os: ubuntu-latest
            target: s390x-unknown-linux-gnu
            strip: s390x-linux-gnu-strip
            linker: CARGO_TARGET_S390X_UNKNOWN_LINUX_GNU_LINKER=s390x-linux-gnu-gcc
            setup: |
              sudo apt update
              sudo apt install -y gcc-s390x-linux-gnu libc6-dev-s390x-cross llvm
          - os: ubuntu-latest
            target: riscv64gc-unknown-linux-gnu
            strip: riscv64-linux-gnu-strip
            linker: CARGO_TARGET_RISCV64GC_UNKNOWN_LINUX_GNU_LINKER=riscv64-linux-gnu-gcc
            setup: |
              sudo apt update
              sudo apt install -y gcc-riscv64-linux-gnu libc6-dev-riscv64-cross
          - os: ubuntu-latest
            target: riscv64gc-unknown-linux-musl
            strip: llvm-strip
            cross: zig
            setup: |
              sudo apt update
              sudo apt install -y gcc-riscv64-linux-gnu libc6-dev-riscv64-cross llvm
          - os: ubuntu-latest
            target: loongarch64-unknown-linux-gnu
            strip: loongarch64-linux-gnu-strip
            linker: CARGO_TARGET_LOONGARCH64_UNKNOWN_LINUX_GNU_LINKER=loongarch64-linux-gnu-gcc-13
            setup: |
              sudo apt update
              sudo apt install -y gcc-13-loongarch64-linux-gnu
          - os: ubuntu-latest
            target: loongarch64-unknown-linux-musl
            strip: llvm-strip
            cross: zig
            setup: |
              sudo apt update
              sudo apt install -y llvm
          - os: ubuntu-latest
            target: aarch64-unknown-linux-ohos
            strip: /home/runner/setup-ohos-sdk/linux/native/llvm/bin/llvm-strip
            linker: CARGO_TARGET_AARCH64_UNKNOWN_LINUX_OHOS_LINKER=/home/runner/setup-ohos-sdk/linux/native/llvm/bin/aarch64-unknown-linux-ohos-clang
          # FreeBSD
          - os: ubuntu-latest
            target: x86_64-unknown-freebsd
            strip: llvm-strip
            cross: cross
            setup: |
              sudo apt update
              sudo apt install -y llvm
          - os: ubuntu-latest
            target: aarch64-unknown-freebsd
            build_std: true
            strip: llvm-strip
            cross: cross
            setup: |
              sudo apt update
              sudo apt install -y llvm

    name: build-${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.os }}
    env:
      BINARY_NAME: ${{ contains(matrix.settings.os, 'windows') && 'lightningcss.exe' || 'lightningcss' }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Setup Android NDK
        if: ${{ matrix.settings.android }}
        working-directory: /tmp
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r28-linux.zip -O ndk.zip
          unzip ndk.zip

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: "yarn"
          cache-dependency-path: lightningcss/yarn.lock
      - name: Setup OpenHarmony SDK
        if: ${{ contains(matrix.settings.target, 'ohos') }}
        uses: openharmony-rs/setup-ohos-sdk@3c181b3244cec76aaec289ab84fb00f55f2fce3f # v0.2.4
      - name: Install Rust
        if: ${{ !matrix.settings.build_std }}
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: ${{ matrix.settings.target }}
      - name: Install Rust
        if: ${{ matrix.settings.build_std }}
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy, rustfmt, rust-src
      - name: Install node.js dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: yarn install
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.napi-rs
            ${{ env.WORKING_DIRECTORY }}/.cargo-cache
          key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.os }}-${{ hashFiles(format('{0}/Cargo.lock', env.WORKING_DIRECTORY)) }}
      - uses: mlugg/setup-zig@v2
        if: ${{ matrix.settings.cross == 'zig' }}
        with:
          version: 0.14.1
      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@v2
        if: ${{ matrix.settings.cross == 'zig' }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild
      - name: Install and prepare cargo-cross
        if: ${{ matrix.settings.cross == 'cross' }}
        run: |
          # install cross
          cargo install --git https://github.com/cross-rs/cross --rev e281947ca900da425e4ecea7483cfde646c8a1ea cross
          # copy Cross.toml to the working directory of lightningcss
          cp Cross.toml ${{ env.WORKING_DIRECTORY }}
          # copy the binary to the working directory
          cp `which sccache` sccache
          # build the image
          docker build --tag ${{ matrix.settings.target }}:sccache --file docker/Dockerfile.${{ matrix.settings.target }} .
      - name: Setup toolchain
        if: ${{ matrix.settings.setup }}
        run: ${{ matrix.settings.setup }}

      - name: Build release
        if: ${{ !matrix.settings.android && matrix.settings.target != 'aarch64-apple-darwin' }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npx napi build --release --platform --manifest-path ./node/Cargo.toml --target ${{ matrix.settings.target }} ${{ matrix.settings.cross == 'zig' && '-x' || matrix.settings.cross == 'napi' && '--use-napi-cross' || matrix.settings.cross == 'cross' && '--use-cross' || '' }} ${{ matrix.settings.build_std && '-- -Z build-std=std,panic_abort +nightly' || '' }}
      - name: Build CLI
        if: ${{ !matrix.settings.android && matrix.settings.target != 'aarch64-apple-darwin' }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          ${{ matrix.settings.linker || '' }} ${{ matrix.settings.cross == 'cross' && 'cross' || 'cargo' }} ${{ matrix.settings.cross == 'zig' && 'zigbuild' || 'build' }} --release --features cli --target ${{ matrix.settings.target }} ${{ matrix.settings.build_std && '-Z build-std=std,panic_abort +nightly' || '' }}
          node -e "require('fs').renameSync('target/${{ matrix.settings.target }}/release/${{ env.BINARY_NAME }}', '${{ env.BINARY_NAME }}')"

      - name: Build release (Apple Silicon)
        if: ${{ matrix.settings.target == 'aarch64-apple-darwin' }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          JEMALLOC_SYS_WITH_LG_PAGE: ${{ matrix.settings.jemalloc_lg_page }}
        run: npx napi build --release --platform --manifest-path ./node/Cargo.toml --target ${{ matrix.settings.target }} ${{ matrix.settings.cross == 'zig' && '-x' || matrix.settings.cross == 'napi' && '--use-napi-cross' || matrix.settings.cross == 'cross' && '--use-cross' || '' }}
      - name: Build CLI (Apple Silicon)
        if: ${{ matrix.settings.target == 'aarch64-apple-darwin' }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          JEMALLOC_SYS_WITH_LG_PAGE: ${{ matrix.settings.jemalloc_lg_page }}
        run: |
          ${{ matrix.settings.linker || '' }} cargo ${{ matrix.settings.cross == 'zig' && 'zigbuild' || 'build' }} --release --features cli --target ${{ matrix.settings.target }}
          node -e "require('fs').renameSync('target/${{ matrix.settings.target }}/release/${{ env.BINARY_NAME }}', '${{ env.BINARY_NAME }}')"

      - name: Build release (android)
        if: ${{ matrix.settings.android }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ANDROID_NDK_LATEST_HOME: ${{ matrix.settings.android_home }}
        run: npx napi build --platform --manifest-path ./node/Cargo.toml --target ${{ matrix.settings.target }}
      - name: Build CLI (android)
        if: ${{ matrix.settings.android }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          ANDROID_NDK_LATEST_HOME: ${{ matrix.settings.android_home }}
        run: |
          ${{ matrix.settings.linker }} cargo build --release --features cli --target ${{ matrix.settings.target }}
          node -e "require('fs').renameSync('target/${{ matrix.settings.target }}/release/${{ env.BINARY_NAME }}', '${{ env.BINARY_NAME }}')"

      - name: Strip debug symbols # https://github.com/rust-lang/rust/issues/46034
        working-directory: ${{ env.WORKING_DIRECTORY }}
        if: ${{ matrix.settings.strip }}
        run: ${{ matrix.settings.strip }} node/*.node ${{ env.BINARY_NAME }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.settings.target }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/node/*.node
            ${{ env.WORKING_DIRECTORY }}/${{ env.BINARY_NAME }}
      - name: Build and tests (no run)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        # currently for cross only
        if: ${{ matrix.settings.cross == 'cross' }}
        run: |
          mkdir -p test_bins
          cross test --all-features --no-run --target ${{ matrix.settings.target }} --message-format=json ${{ matrix.settings.build_std && '-Z build-std=std,panic_abort +nightly' || '' }} 2>cross.log | grep -E '^\{' | tee cargo-test.jsonl > /dev/null
          cat cross.log
          jq -r 'select(.reason=="compiler-artifact")|select(.profile.test==true)|.executable//empty' cargo-test.jsonl | sed "s|^/target|target|" | tr '\n' '\0' | xargs -0 -I{} cp "{}" test_bins/
          cp target/${{ matrix.settings.target }}/debug/lightningcss test_bins/
          ls -alh test_bins/
      - name: Upload test
        if: ${{ matrix.settings.cross == 'cross' }}
        uses: actions/upload-artifact@v6
        with:
          name: test-${{ matrix.settings.target }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/test_bins

  test-freebsd-js-rust:
    name: Test on FreeBSD ${{ matrix.version }} ${{ matrix.architecture }}
    needs: build
    strategy:
      fail-fast: false
      matrix:
        version: ["15.0", "14.3", "13.5"]
        architecture: ["x86-64", "arm64"]
        exclude:
          - version: "13.5"
            architecture: "arm64"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: bindings-${{ matrix.architecture == 'arm64' && 'aarch64-unknown-freebsd' || 'x86_64-unknown-freebsd' }}
          path: ${{ env.WORKING_DIRECTORY }}
      - name: Download test
        uses: actions/download-artifact@v7
        with:
          name: test-${{ matrix.architecture == 'arm64' && 'aarch64-unknown-freebsd' || 'x86_64-unknown-freebsd' }}
          path: ${{ env.WORKING_DIRECTORY }}/test_bins
      - uses: cross-platform-actions/action@492b0c80085400348c599edace11141a4ee73524 # v0.32.0
        with:
          operating_system: freebsd
          architecture: ${{ matrix.architecture }}
          version: ${{ matrix.version }}
          memory: 13G
          cpu_count: 3
          shell: bash
          run: |
            sudo pkg install -y node npm yarn
            cd lightningcss
            # test js binding
            yarn install --ignore-scripts || true
            yarn test
            node -e "require('.')"
            # check cli
            file lightningcss
            chmod +x lightningcss test_bins/*
            ./lightningcss --help
            export RAYON_NUM_THREADS=1
            # run cargo test binaries
            if [ -d test_bins ]; then
              for bin in test_bins/*; do
                [ -f "$bin" ] || continue
                if [ "$(basename "$bin")" = "lightningcss" ]; then
                  continue
                fi
                echo "=== $bin ==="
                "$bin"
              done
            else
              echo "test_bins directory not found"
              exit 1
            fi

  build-test-wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: "yarn"
          cache-dependency-path: lightningcss/yarn.lock
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install wasm-opt
        run: sudo apt update && sudo apt install -y binaryen
      - name: Build wasm
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          yarn install
          yarn wasm:build-release
      - name: Patch tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          # HACK: inject `napi_is_arraybuffer`
          wget https://raw.githubusercontent.com/IronBlood/napi-wasm/refs/heads/napi_is_arraybuffer/index.mjs -O wasm/node_modules/napi-wasm/index.mjs
      - name: Run test (node)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: TEST_WASM=node yarn test
      - name: Run test (browser)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: TEST_WASM=node yarn test
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm
          path: ${{ env.WORKING_DIRECTORY }}/wasm/lightningcss_node.wasm

  test-rust:
    name: Test Rust for ${{ matrix.settings.target }}
    strategy:
      fail-fast: false
      matrix:
        settings:
          # Windows
          - host: windows-latest
            target: x86_64-pc-windows-msvc
          - host: windows-latest
            target: i686-pc-windows-msvc
          - host: windows-11-arm
            target: aarch64-pc-windows-msvc
          # macOS
          - host: macos-latest
            target: x86_64-apple-darwin
          - host: macos-latest
            target: aarch64-apple-darwin
          # Linux
          - host: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - host: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
            setup: cargo install cargo-zigbuild
            test: cargo zigbuild --tests --all-features --target aarch64-unknown-linux-musl
          - host: ubuntu-24.04-arm
            target: armv7-unknown-linux-gnueabihf
            setup: sudo dpkg --add-architecture armhf && sudo apt update && sudo apt install -y gcc-arm-linux-gnueabihf libc6:armhf libgcc-s1:armhf libstdc++6:armhf
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ${{ env.WORKING_DIRECTORY }}
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - uses: mlugg/setup-zig@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        with:
          version: 0.14.1
      - name: Setup toolchain
        if: ${{ matrix.settings.setup }}
        run: ${{ matrix.settings.setup }}
      - name: Cargo test
        if: ${{ !matrix.settings.test }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          CARGO_TERM_COLOR: always
          RUST_BACKTRACE: full
          RAYON_NUM_THREADS: 1
        run: cargo test --all-features --target ${{ matrix.settings.target }}
      - name: Cargo test (customized test commands)
        if: ${{ matrix.settings.test }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          CARGO_TERM_COLOR: always
          RUST_BACKTRACE: full
          RAYON_NUM_THREADS: 1
        run: ${{ matrix.settings.test }}

  test-js-win-mac:
    name: Test Bindings on ${{ matrix.settings.target }} - node@${{ matrix.node }}
    needs:
      - build
    strategy:
      fail-fast: false
      matrix:
        node:
          - "20"
          - "22"
          - "24"
        settings:
          # Windows
          - host: windows-latest
            target: x86_64-pc-windows-msvc
            architecture: x64
          - host: windows-11-arm
            target: aarch64-pc-windows-msvc
            architecture: arm64
          # MacOS
          - host: macos-latest
            target: aarch64-apple-darwin
            architecture: arm64
          - host: macos-latest
            target: x86_64-apple-darwin
            architecture: x64
    runs-on: ${{ matrix.settings.host }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: yarn
          architecture: ${{ matrix.settings.architecture }}
          cache-dependency-path: lightningcss/yarn.lock
      - name: Install node.js dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        # NOTE skip installing puppeteer, doesn't support on some systems
        run: yarn install --ignore-scripts
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: bindings-${{ matrix.settings.target }}
          path: ${{ env.WORKING_DIRECTORY }}
      - name: Test bindings
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: yarn test

  test-js-linux:
    name: Test Bindings on ${{ matrix.target }} - node@${{ matrix.node }}
    needs:
      - build
    strategy:
      fail-fast: false
      matrix:
        node:
          - "20"
          - "22"
          - "24"
        target:
          - x86_64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-gnu
          - aarch64-unknown-linux-musl
          - armv7-unknown-linux-gnueabihf
        exclude:
          - node: "24"
            target: armv7-unknown-linux-gnueabihf
    runs-on: ${{ contains(matrix.target, 'aarch64') && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/checkout-repo
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}
          cache: yarn
          cache-dependency-path: lightningcss/yarn.lock
      - name: Output docker params
        id: docker
        run: |
          node -e "
            if ('${{ matrix.target }}'.startsWith('aarch64')) {
              console.log('PLATFORM=linux/arm64')
            } else if ('${{ matrix.target }}'.startsWith('armv7')) {
              console.log('PLATFORM=linux/arm/v7')
            } else {
              console.log('PLATFORM=linux/amd64')
            }
          " >> $GITHUB_OUTPUT
          node -e "
            if ('${{ matrix.target }}'.endsWith('-musl')) {
              console.log('IMAGE=node:${{ matrix.node }}-alpine')
            } else {
              console.log('IMAGE=node:${{ matrix.node }}-slim')
            }
          " >> $GITHUB_OUTPUT
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          yarn config set --json supportedArchitectures.cpu '["current", "arm64", "x64", "arm"]'
          yarn config set --json supportedArchitectures.libc '["current", "musl", "gnu"]'
          yarn install --ignore-scripts
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: bindings-${{ matrix.target }}
          path: ${{ env.WORKING_DIRECTORY }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        if: ${{ contains(matrix.target, 'armv7') }}
        with:
          platforms: all
      - run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
        if: ${{ contains(matrix.target, 'armv7') }}
      - name: Test bindings
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ steps.docker.outputs.IMAGE }}
          options: -v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}/${{ env.WORKING_DIRECTORY }} --platform ${{ steps.docker.outputs.PLATFORM }}
          run: yarn test
